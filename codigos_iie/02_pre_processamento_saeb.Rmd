---
title: "Pré-processamento — SAEB (IIE) GERAL"
author: "Lupa Social"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# 1. Objetivo

Este script processa os microdados do **SAEB (3º ano do Ensino Médio)** para os anos de 2015, 2017, 2019 e 2021. O objetivo é calcular a distribuição de alunos em níveis de proficiência (Abaixo do Básico vs. Básico/Acima) cruzada com a trajetória de idade-série.

> **Nota Metodológica Importante:** > O SAEB utiliza questionários contextuais para identificar a idade do aluno. Em **2019**, o Inep não forneceu a variável de idade necessária para a classificação de trajetória. Por esse motivo, os dados de 2019 são processados apenas como **total**, sem a quebra por grupo (adiantado/linha/atrasado). o script final de cálculo do IIE apresenta o tratamento adequado feito para lidar com essa limitação do SAEB. 

# 2. Configuração e Funções de Apoio

Carregamos os pacotes e definimos as funções que padronizam as UFs e as regiões.

```{r pacotes}
library(tidyverse)
library(glue)
library(readr)
library(writexl)
```

```{r funcoes_auxiliares}
BASE_DIR <- "../../Dados"

# Padronização de Região
uf_to_regiao <- function(uf) {
  dplyr::case_when(
    uf %in% 11:17 ~ "Norte",
    uf %in% 21:29 ~ "Nordeste",
    uf %in% 31:35 ~ "Sudeste",
    uf %in% 41:43 ~ "Sul",
    uf %in% 50:53 ~ "Centro-Oeste",
    uf == 0       ~ "Brasil",
    TRUE          ~ NA_character_
  )
}

# Normalização do nome da coluna de UF entre as edições
normalize_uf_saeb <- function(df) {
  df <- df %>% rename_with(tolower)
  if ("uf" %in% names(df)) {
    df %>% mutate(uf = as.integer(uf))
  } else if ("id_uf" %in% names(df)) {
    df %>% mutate(uf = as.integer(id_uf))
  } else {
    stop("Coluna de UF não identificada.")
  }
}
```

# 3. Classificação de Trajetória e Proficiência

Definimos as réguas de corte do IIE:
* **Abaixo do Básico**: Proficiência em Língua Portuguesa < 300 **OU** Matemática < 300.
* **Básico/Acima**: Proficiência em Língua Portuguesa >= 300 **E** Matemática >= 300.

```{r mapeamento_logica}
# Mapeamento de Idade-Série (Edições 2015 e 2017)
map_idade_serie_saeb <- function(df, var_idade) {
  df %>%
    mutate(
      idade_serie = case_when(
        toupper(as.character(.data[[var_idade]])) %in% c("A", "B") ~ "adiantado",
        toupper(as.character(.data[[var_idade]])) == "C"           ~ "linha",
        toupper(as.character(.data[[var_idade]])) == "D"           ~ "atrasado",
        toupper(as.character(.data[[var_idade]])) %in% c("E","F","G","H") ~ "atrasado2",
        TRUE ~ NA_character_
      )
    )
}
```

# 4. Processamento por Blocos Temporais

Devido às mudanças nos questionários do SAEB, o processamento é dividido entre o bloco histórico (2015-2019) e o bloco recente (2021). **Arquivos são lidos via `read_delim` com separador `;`**.

## 4.1 Bloco 2015, 2017 e 2019

```{r bloco_historico}
processa_saeb_historico <- function(ano) {
  # Leitura otimizada em CSV
  caminho <- file.path(BASE_DIR, glue("TS_ALUNO_3EM_{ano}.csv"))
  df <- read_delim(caminho, delim = ";", show_col_types = FALSE) %>% 
    normalize_uf_saeb()

  base <- df %>%
    filter(!is.na(proficiencia_lp_saeb), !is.na(proficiencia_mt_saeb)) %>%
    mutate(
      abaixo = as.integer(proficiencia_lp_saeb < 300 | proficiencia_mt_saeb < 300),
      basico = as.integer(proficiencia_lp_saeb >= 300 & proficiencia_mt_saeb >= 300),
      peso   = as.numeric(peso_aluno_lp)
    )

  if (ano %in% c(2015, 2017)) {
    out <- base %>%
      map_idade_serie_saeb("tx_resp_q004") %>%
      filter(!is.na(idade_serie)) %>%
      group_by(uf, grupo = idade_serie) %>% 
      summarise(
        abaixo = sum(abaixo * peso, na.rm = TRUE),
        basico = sum(basico * peso, na.rm = TRUE),
        .groups = "drop"
      )
  } else { 
    # TRATAMENTO ESPECIAL 2019: Sem informação de idade
    out <- base %>%
      group_by(uf) %>% 
      summarise(
        abaixo = sum(abaixo * peso, na.rm = TRUE),
        basico = sum(basico * peso, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(grupo = "total")
  }
  
  out %>% 
    pivot_longer(c(abaixo, basico), names_to = "metric", values_to = "valor") %>%
    mutate(ano = ano, regiao = uf_to_regiao(uf))
}
```

## 4.2 Bloco Recente (2021)

Em 2021, a variável de idade mudou para `tx_resp_q02`.

```{r bloco_2021}
processa_saeb_2021 <- function() {
  caminho <- file.path(BASE_DIR, "TS_ALUNO_3EM_2021.csv")
  
  df <- read_delim(caminho, delim = ";", show_col_types = FALSE) %>%
    rename_with(tolower) %>%
    mutate(uf = as.integer(id_uf)) %>%
    filter(!is.na(uf), !is.na(proficiencia_lp_saeb))

  df %>%
    mutate(
      abaixo = as.integer(proficiencia_lp_saeb < 300 | proficiencia_mt_saeb < 300),
      basico = as.integer(proficiencia_lp_saeb >= 300 & proficiencia_mt_saeb >= 300),
      code   = stringr::str_sub(as.character(tx_resp_q02), 1, 1),
      grupo  = case_when(
        code == "A" ~ "adiantado",
        code == "B" ~ "linha",
        code == "C" ~ "atrasado",
        code %in% c("D", "E", "F") ~ "atrasado2",
        TRUE ~ NA_character_
      )
    ) %>%
    filter(!is.na(grupo)) %>%
    group_by(uf, regiao = uf_to_regiao(uf), grupo) %>%
    summarise(
      abaixo = sum(abaixo * peso_aluno_lp, na.rm = TRUE),
      basico = sum(basico * peso_aluno_lp, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    pivot_longer(c(abaixo, basico), names_to = "metric", values_to = "valor") %>%
    mutate(ano = 2021L)
}
```

# 5. Consolidação e Exportação

Unificamos as bases e geramos o agregado Brasil.

```{r consolidacao}
# Executar processamentos
saeb_historico <- map_dfr(c(2015, 2017, 2019), processa_saeb_historico)
saeb_2021      <- processa_saeb_2021()

saeb_geral <- bind_rows(saeb_historico, saeb_2021) %>%
  # Padronização de nomes de grupos para compatibilidade
  mutate(grupo = recode(grupo, "atrasado" = "atrasado1ano", "atrasado2" = "atrasado2anos"))

# Criar agregado Brasil (UF = 0)
brasil_saeb <- saeb_geral %>%
  group_by(ano, grupo, metric) %>%
  summarise(valor = sum(valor, na.rm = TRUE), .groups = "drop") %>%
  mutate(uf = 0, regiao = "Brasil")

saeb_final <- bind_rows(saeb_geral, brasil_saeb) %>%
  mutate(valor = round(valor)) %>%
  arrange(ano, uf, grupo)

# Salvar RDS para uso nos próximos scripts
saveRDS(saeb_final, file = "../Dados/saeb_iie_geral.rds")
```

# 6. Dicionário de colunas

* **ano**: Ano da edição do SAEB (2015, 2017, 2019 ou 2021).

* **uf**: Código da Unidade Federativa (0 indica o total Brasil).

* **regiao**: Nome da grande região ou "Brasil".

* **grupo**: Trajetória do aluno (adiantado, linha, atrasado1ano, atrasado2anos). Para 2019, o valor é "total".

* **metric**: Categoria de desempenho:
    - **abaixo**: Alunos com desempenho insuficiente em pelo menos uma das áreas (< 300).
    - **basico**: Alunos com desempenho adequado em ambas as áreas (>= 300).
* **valor**: Soma ponderada das matrículas (usando o peso do aluno para expansão da amostra).

---