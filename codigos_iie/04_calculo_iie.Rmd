---
title: "Cálculo do Índice de Inclusão Educacional (IIE) — Geral"
author: "Lupa Social"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: journal
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# 1. Introdução e Metodologia

O IIE é um índice sintético que combina:
1. **Fluxo e Coorte (Censo Escolar)**: Quantos jovens atingem o fim da educação básica.
2. **Aprendizado (SAEB)**: Qual a qualidade desse aprendizado.
3. **População Fora da Escola (PNADc)**: Ajuste para incluir jovens que sequer aparecem nos registros escolares.

O índice é calculado pela fórmula:
$$IIE = \frac{\text{Aprovados no 3º EM com Aprendizado Básico}}{\text{Total da Coorte de Referência}} \times 100$$

# 2. Preparação do Ambiente

Carregamos os pacotes e os arquivos `.rds` gerados nos scripts de pré-processamento.

```{r pacotes}
library(tidyverse)
library(writexl)

# Diretório de insumos
DIR_DADOS <- "../Dados"

# Leitura dos arquivos RDS
censo_hist <- readRDS(file.path(DIR_DADOS, "censo_escolar_iie_geral.rds"))
# Nota: Unificando possíveis arquivos de 2021 se estiverem separados
censo      <- censo_hist 
pnadc      <- readRDS(file.path(DIR_DADOS, "pnadc_iie_geral.rds"))
saeb       <- readRDS(file.path(DIR_DADOS, "saeb_iie_geral.rds"))
```

# 3. Funções de Cálculo e Ajuste

O IIE exige que a população "Fora da Escola" (da PNADc) seja somada ao grupo de "Atrasados 2+ anos" do Censo, criando uma coorte ajustada.

```{r funcoes_auxiliares}
# Divisão segura para evitar erros de denominador zero
safe_div <- function(a, b) ifelse(is.finite(b) & b != 0, a/b, 0)

# Mapeamento de siglas de UF
uf_map <- tibble::tibble(
  uf = c(0, 11,12,13,14,15,16,17,21,22,23,24,25,26,27,28,29,
         31,32,33,35,41,42,43,50,51,52,53),
  uf_sigla = c("BR","RO","AC","AM","RR","PA","AP","TO","MA","PI","CE","RN","PB","PE","AL","SE","BA",
               "MG","ES","RJ","SP","PR","SC","RS","MS","MT","GO","DF")
)
```

# 4. Cálculo para Anos Regulares (2015, 2017, 2021)

Nestes anos, temos dados completos de idade tanto no Censo quanto no SAEB.

```{r calculo_regular}
# Preparação do Censo
df_censo <- censo %>%
  filter(ano %in% c(2015, 2017, 2021)) %>%
  mutate(grupo = tolower(grupo)) %>%
  pivot_wider(names_from = grupo, values_from = n, values_fill = 0)

# Preparação do SAEB (Cálculo da probabilidade de ser básico p_basico)
df_saeb <- saeb %>%
  filter(ano %in% c(2015, 2017, 2021), grupo != "total") %>%
  mutate(grupo = recode(grupo, "linha" = "emlinha", "atrasado1ano" = "atrasado", "atrasado2anos" = "atrasado2")) %>%
  pivot_wider(names_from = metric, values_from = valor, values_fill = 0) %>%
  mutate(p_basico = safe_div(basico, basico + abaixo)) %>%
  select(ano, uf, grupo, p_basico) %>%
  pivot_wider(names_from = grupo, values_from = p_basico, names_prefix = "p_basico_")

# Preparação PNADc
df_pnadc <- pnadc %>%
  filter(ano %in% c(2015, 2017, 2021)) %>%
  mutate(perc_fora = safe_div(coorte_fora_sem_EM_PNAD, coorte_PNAD))

# Integração Final
iie_151721 <- df_censo %>%
  left_join(df_pnadc, by = c("ano", "uf")) %>%
  left_join(df_saeb, by = c("ano", "uf")) %>%
  mutate(
    # Ajuste da coorte pela PNADc
    coorte_total_aj = safe_div((coorte_adiantado_censo + coorte_emlinha_censo + coorte_atrasado_censo + coorte_atrasado2_censo), (1 - perc_fora)),
    fora_escola = pmax(coorte_total_aj - (coorte_adiantado_censo + coorte_emlinha_censo + coorte_atrasado_censo + coorte_atrasado2_censo), 0),
    atrasado2_aj = coorte_atrasado2_censo + fora_escola,
    
    # Cálculo do Numerador (Quem é básico)
    num = (coorte_adiantado_censo * p_basico_adiantado) + 
          (coorte_emlinha_censo * p_basico_emlinha) + 
          (coorte_atrasado_censo * p_basico_atrasado),
    
    # Cálculo do Denominador (Total da Coorte)
    den = (coorte_adiantado_censo) + (coorte_emlinha_censo) + 
          (coorte_atrasado_censo) + (atrasado2_aj),
    
    IIE = safe_div(num, den) * 100
  ) %>%
  select(ano, uf, IIE)
```

# 5. Estimativa Especial para 2019

Em 2019, aplicamos as proporções de desempenho por grupo de 2017 sobre o total observado em 2019.

```{r calculo_2019}
# Esta etapa utiliza a função complexa de redistribuição de pesos
# conforme definida na metodologia da Lupa Social e Instituto Naturapara anos sem SAEB contextual
iie_2019 <- calc_iie_2019_geral(censo, saeb, pnadc) %>%
  mutate(ano = 2019) %>%
  rename(IIE = IIE_2019)
```

# 6. Consolidação dos Resultados

Unimos todos os anos e formatamos para a saída final.

```{r consolidacao}
iie_final <- bind_rows(iie_151721, iie_2019) %>%
  left_join(uf_map, by = "uf") %>%
  mutate(IIE_Geral = round(IIE, 1)) %>%
  select(ano, uf, uf_sigla, IIE_Geral) %>%
  arrange(ano, uf)

# Visualização dos resultados para o Brasil (UF 0)
iie_final %>% filter(uf == 0)
```

# 7. Exportação

Os resultados são salvos em Excel para fácil consulta e publicação.

```{r exportacao}
writexl::write_xlsx(iie_final, "../Resultados/iie_geral_2015_2021.xlsx")
```

# Dicionário de Colunas Final

* **ano**: Ano de referência do índice.
* **uf**: Código do IBGE para a Unidade da Federação (0 = Brasil).
* **uf_sigla**: Sigla da UF.
* **IIE_Geral**: Valor final do Índice de Inclusão Educacional (0 a 100).

---
